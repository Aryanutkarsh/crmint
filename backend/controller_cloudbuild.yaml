steps:
  # Pulls the latest images to enable caching.
  - name: 'gcr.io/cloud-builders/docker'
    env:
      - 'PROJECT_ID=$PROJECT_ID'
    script: |
      #!/usr/bin/bash
      docker pull europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-base:latest || true
      docker pull europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-builder:latest || true
      docker pull europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller:latest || true

  # Builds the base image to cache it later on
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--cache-from', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-base:latest',
      '--build-arg', 'BUILDKIT_INLINE_CACHE=1',
      '--target', 'base',
      '-t', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-base:latest',
      '-f', 'controller.Dockerfile',
      '.',
    ]
    env:
      - 'DOCKER_BUILDKIT=1'

  # Builds the builder image to cache it later on
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--cache-from', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-base:latest',
      '--cache-from', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-builder:latest',
      '--build-arg', 'BUILDKIT_INLINE_CACHE=1',
      '--target', 'builder',
      '-t', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-builder:latest',
      '-f', 'controller.Dockerfile',
      '.',
    ]
    env:
      - 'DOCKER_BUILDKIT=1'

  # Builds the app image.
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--cache-from', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-base:latest',
      '--cache-from', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-builder:latest',
      '--cache-from', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller:latest',
      '--build-arg', 'BUILDKIT_INLINE_CACHE=1',
      '-t', 'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller',
      '-f', 'controller.Dockerfile',
      '.',
    ]
    env:
      - 'DOCKER_BUILDKIT=1'

images: [
  'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-base',
  'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller-builder',
  'europe-docker.pkg.dev/${PROJECT_ID}/crmint/controller',
]
